<apex:page showHeader="true" sidebar="true" standardController="Account"  extensions="AccountChartController"
           lightningStylesheets="true" docType="html-5.0">
    <apex:slds />
    <apex:actionstatus id="myStatus">
        <apex:facet name="start">
            <div class="demo-only popupBackground" id="myStatus1">
                <div role="status" class="custPopup slds-spinner slds-spinner_medium slds-spinner_brand">
                    <span class="slds-assistive-text">Please wait...</span>
                    <div class="slds-spinner__dot-a"></div>
                    <div class="slds-spinner__dot-b"></div>
                </div>
            </div>
        </apex:facet>
    </apex:actionstatus>  
    <head>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <style>
        
            .expired{
                color:red!important;
            }
            .tooltip {
  position: relative;
  display: inline-block;
  border-bottom: 1px dotted black;
}

.tooltip .tooltiptext {
    visibility: hidden;    
    background-color: #a7dbf0;
    color: #fff;
    text-align: left;
    border-radius: 6px;
    padding: 15px;
    position: absolute;
    z-index: 1;   
    left: 0%;    
    opacity: 0;
    transition: opacity 0.3s;
}

.tooltip .tooltiptext::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #555 transparent transparent transparent;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}
        
            .tdLeft{
                padding-left:5px!important;
            }
            .tdLeftOne{
                padding-left:5px!important;
                width:35%!important;
            }
        .pricingTable{
            width:100%!important;
        }
        .checkboxClass{
            margin-left:0px!important;
        }
            .custPopup{ border-width: 0px; border-radius:10px; z-index: 9999; left: 50%; padding:20px; position: fixed; top:40%;}
        /* These are the 3 css properties you will need to change so the popup displays in the center of the screen. First set the width. Then set margin-left to negative half of what the width is. You can add the height property for a fixed size pop up if you want.*/ 
        .popupBackground{ background-color:rgba(158, 158, 158, 0.34); opacity: 1.0; filter: alpha(opacity = 30); position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: 9998; } 
        
            #col1 {
        width: 24%;
        padding-top: 20pt;
        }
        
        #col2 {
        width: 74%;
        }
        
        #colA2 {
        width: 30%;
        
        
        }
        
        #col1,
        #col2 {
        display: inline-block;
        text-align: left;        
        padding-bottom: 20pt;
        padding-left: auto;
        padding-right: auto;
        margin-left: auto;
        margin-right: auto;
        vertical-align: top;
        border: 2px solid grey;
        border-radius: 10px 10px 10px 10px;
        -moz-border-radius: 10px 10px 10px 10px;
        -webkit-border-radius: 10px 10px 10px 10px;
        }
        
        div[class$="errorDiv"] {
            color: red;
            font-size: 16pt;
            display: block;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            margin-left: 0.5em;
            margin-right: 0.5em;
        }
        
        hr {
            display: block;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            margin-left: auto;
            margin-right: auto;
            border-style: inset;
            border-width: 1px;
        }
        
        #pricingTable,
        #commentsTable {
        width: 95%;
        text-align: center;
        align-self: center;
        padding-left: auto;
        padding-right: auto;
        margin-left: auto;
        margin-right: auto;
        }
        
        td[class$="Left"] {
            text-align: left;
            padding-bottom: 5pt;
            padding-top: 5pt;
        }
        
        div[class$="Left"] {
            text-align: left;
            padding-bottom: 5pt;
            padding-top: 5pt;
        }
        .slds-scope .slds-page-header{
            padding:5px!important;
            border-radius:5px;
        }
        .slds-scope .slds-page-header__title{
            font-size:17px!important;   
            
        }
        .slds-page-header{
            background:#a7dbf0!important;
        }
        .row {
            margin-right: 0px!important;
            margin-left:  0px!important;
        }
        .list-group-item{
            border:1px solid #f9f9f9!important;
        }
        .account,.market,.volume,.type,.unitofmeasure{
            width:20%;
            float:left;
        }
        .header-row{
            display:flex;
            margin:10px 10px 10px 62px;
        }
        .header-row .account{
            text-align:left!important;
            
        }
        [data-type="tree"] ul li [data-role="expander"].bt-tree-glyphicons-expander {
            width: 24px;
        }
        
        ul.bt-list li [data-role="expander"] {
            display: table-cell;
            vertical-align: middle;
            text-align: center;
            cursor: pointer;
        }
        .glyphicon-plus{
            font-size:25px!important;
            font-weight:bold!important;
        }
        [data-type="tree"] ul li [data-role="expander"].bt-tree-glyphicons-expander .glyphicon {
            top: 0px;
            height: 24px;
        }
        
        .glyphicon {
            position: relative;
            top: 1px;
            display: inline-block;
            font-style: normal;
            font-weight: 400;
            line-height: 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .glyphicon-plus:before {
            content: "\002b";
        }
        .glyphicon-minus{
            font-size: 25px!important;
            font-weight: bold!important;
        }
        [data-type="tree"] ul li [data-role="expander"].bt-tree-glyphicons-expander {
            width: 24px;
        }
        
        ul.bt-list li [data-role="expander"] {
            display: table-cell;
            vertical-align: middle;
            text-align: center;
            cursor: pointer;
        }
        .glyphicon-minus:before {
            content: "\2212";
        }
        .bt-hidden {
            display: none;
        }
        ul.bt-list-bootstrap {
            padding-left: 0;
            margin-bottom: 0;
        }
        .bt-tree-bootstrap-3 ul.bt-list-bootstrap li {
            border: 0;
            border-radius: 0;
            color: #333;
        }
        
        ul.bt-list-bootstrap li [data-role="wrapper"] {
            padding: 0 10px;
        }
        
        ul.bt-list li [data-role="wrapper"] {
            display: table;
            width: 100%;
        }
        ul.bt-list li [data-role="spacer"] {
            display: table-cell;
        }
        ul.bt-list li [data-role="expander"] {
            display: table-cell;
            vertical-align: middle;
            text-align: center;
            cursor: pointer;
        }
        ul.bt-list-bootstrap li [data-role="checkbox"] {
            width: 24px;
            padding: 3px;
        }
        
        ul.bt-list li [data-role="checkbox"] {
            display: table-cell;
            vertical-align: middle;
            text-align: center;
        }
        .bt-checkbox-bootstrap {
            min-width: 0;
            font-size: 0;
            font-weight: 400;
            margin: 0;
            text-align: center;
            width: 18px;
            height: 18px;
            position: relative;
            display: inline;
        }
        .bt-checkbox-bootstrap input[type="checkbox"] {
            display: none;
            margin-bottom: -12px;
        }
        
        input[type="checkbox"], .checkbox input[type="checkbox"], .checkbox-inline input[type="checkbox"] {
            position: relative;
            border: none;
            
            -webkit-appearance: none;
            
            cursor: pointer;
        }
        
        .bt-checkbox-bootstrap span {
            background: #fff;
            display: block;
            content: " ";
            width: 18px;
            height: 18px;
            line-height: 11px;
            font-size: 11px;
            padding: 2px;
            color: #555;
            border: 1px solid #CCC;
            border-radius: 3px;
            transition: box-shadow 0.2s linear,border-color 0.2s linear;
            cursor: pointer;
            margin: auto;
        }
        ul.bt-list-bootstrap li [data-role="display"] {
            padding: 8px 0 8px 4px;
        }
        
        ul.bt-list li [data-role="display"] {
            display: table-cell;
            vertical-align: middle;
            cursor: pointer;
        }
        
        
        .bt-checkbox-glyphicons input[type="checkbox"]:checked + span:after {
            display: block;
            content: '';
            height: .25rem;
            width: .5rem;
            position: relative;
            top: 50%;
            margin-left: 5px;
            transform: translate3d(-50%, -50%, 0) rotate(-45deg);
            border-bottom: 2px solid rgb(0, 112, 210);
            border-left: 2px solid rgb(0, 112, 210);
        }
        
        
        .searchResult  {
            
            position: relative;
            display: inline-block;
            border: 1px solid transparent;
            padding: 0;
            font-size: .75rem!important;
            line-height: 1.875rem!important;
            text-decoration: none;
            white-space: normal;
            border-radius: .25rem;
            background: transparent;
            background-clip: border-box;
            
            user-select: none;
            
            padding-left: 1rem;
            padding-right: 1rem;
            text-align: center;
            vertical-align: middle;
            border: 1px solid rgb(221, 219, 218);
            
            transition: border 0.15s linear;
            background-color: rgba(27, 82, 151, 1);
            border-color: rgba(27, 82, 151, 1);
            color: rgb(255, 255, 255)!important;
        }
        
        .bt-checkbox-glyphicons input[type="checkbox"]:indeterminate + span:after {
            display: inline-block;
            font-family: 'Glyphicons Halflings';
            content: "\2212 ";
            padding-right: 1px;
        }   
        .radio-btn table{
            margin-left:5%!important;  
            width:100%!important;
        }
        .radio-btn table td{
            width:20%!important;            
        }
        .radio-btn fieldset{
            border: 1px solid!important; 
            border-radius: 5px;
            width: 50%;
            margin-left: 10px;
            padding: 5px;
        }
        
        </style>
        </head>
        
        <body>
            <!--<apex:stylesheet value="{!URLFOR($Resource.bootree, 'bootree/bootree.min.css')}"/>-->
                <!--<apex:stylesheet value="{!URLFOR($Resource.bootree, 'bootree/bootstrap.min.css')}"/>-->
                    
                    <apex:includeScript value="{!URLFOR($Resource.bootree, 'bootree/jquery-3.3.1.min.js')}"/>
                        <apex:includeScript value="{!URLFOR($Resource.bootree, 'bootree/bootree.min.js')}"/>
                            
                           
                                
                            <apex:form id="frm" onkeydown="submitListener(event);">
                                
                                <apex:inputHidden value="{!siteAccountIds}" Id="childAccounts" />
                                                    <apex:pageBlock id="pbSection">
                                                        <script type="text/javascript">
                                                            google.charts.load('current', {
                                                                packages: ['corechart', 'line']
                                                            });
        google.charts.setOnLoadCallback(drawBackgroundColor);
        
        function drawBackgroundColor() {
            var selectedCehckBox = '';
            if (document.getElementById('{!$Component.selectedSupplierValue}') != undefined) {
                selectedCehckBox = document.getElementById('{!$Component.selectedSupplierValue}').value;
            }
            var selectedChecboxId = selectedCehckBox.split(';');
            for (var checkIndex = 0; checkIndex < selectedChecboxId.length; checkIndex++) {
                if (document.getElementById(selectedChecboxId[checkIndex]) != null) {
                    document.getElementById(selectedChecboxId[checkIndex]).checked = true;
                }
            }
            
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Contract Duration (years)');
            //  data.addColumn('number', 'Price/Year');
            //console.log(JSON.parse('{!supplierString}'));
            //console.log(JSON.parse('{!yearOfContractPricesString}'));
            var apexResponse = '{!JSENCODE(yearOfContractPricesString)}'.length > 0 ? JSON.parse(
                '{!yearOfContractPricesString}') : '';
            var suppliers = '{!JSENCODE(supplierString)}'.length > 0 ? JSON.parse('{!supplierString}') : '';
            var chartData = [];
            var maxValue = 0;
            for (supplierKey in suppliers) {
                data.addColumn('number', suppliers[supplierKey]);
            }
            //data.addColumn('number', 'Min');
            //if(suppliers.length==1){
            //data.addColumn('number', 'Max');
            //  }
            for (yearOfContractAskey in apexResponse) {
                //alert('test');
                var nodeData = []
                var yearOfContractData = apexResponse[yearOfContractAskey];
                maxValue = yearOfContractAskey > maxValue ? Math.ceil(yearOfContractAskey) : maxValue;
                nodeData.push(parseInt(yearOfContractAskey) * 12 + '');
                for (var i = 0; i < yearOfContractData.length; i++) {
                    nodeData.push(yearOfContractData[i]);
                }
                
                chartData.push(nodeData);
            }
            console.log('chartData = '+JSON.stringify(chartData));
            data.addRows(chartData);
            var options = {
                hAxis: {
                    title: 'Months of contract',
                    gridlines: {
                        count: parseInt(maxValue),
                    }
                },
                vAxis: {
                    title: 'Price'
                }
            };
            var chart;
            if (document.getElementById('chart_div') != undefined) {
                chart = new google.visualization.LineChart(document.getElementById('chart_div'));
                chart.draw(data, options);
                google.visualization.events.addListener(chart, 'select', selectHandler);
            }
            
            
            
            function selectHandler() {
                
                console.log("here.......");
                var selection = chart.getSelection();
                if (selection == undefined || selection[0] == undefined || selection[0].row == null ||
                    selection[0].row == undefined) {
                    return;
                }
                console.log(selection[0].column);
                var price = data.getFormattedValue(selection[0].row, selection[0].column);
                var years = data.getValue(chart.getSelection()[0].row, 0);
                //alert(suppliers[selection[0].column-1])
                if(price > 0){
                    document.getElementById('ZeroModal').style.display = 'none';
                    ctrl_setPricingValues(price, years, suppliers[selection[0].column - 1]);
                }else{
                    var objDiv = document.getElementById("ZeroModal");
                    objDiv.style.display = 'block'; 
                    if(document.getElementById('{! $Component.pbSection}'+':saveOfferId') != null){
                        document.getElementById('{! $Component.pbSection}'+':saveOfferId').disabled = true;   
                    }
                }
                
            }
        }
        </script>
        <script>
        function refreshPage(){
            window.location.href = window.location.href ;
        }
        var selectedOppIndex = '';
        
        function setSupplierValue(val) {
            var checkBoxes = document.getElementsByClassName('checkboxClass');
            var selectedVal = '';
            for (var i = 0; i < checkBoxes.length; i++) {
                if (checkBoxes[i].checked) {
                    selectedVal += checkBoxes[i].value + ';';
                }
            }
            selectedVal = selectedVal.substring(0, selectedVal.length - 1);
            console.log('*** selectedVal :: '+selectedVal);
            document.getElementById('{!$Component.selectedSupplierValue}').value = selectedVal;
        }
        
        </script>
        
        <!-- ======================================== -->
        
        
        <apex:actionFunction action="{!setPricingValues}" name="ctrl_setPricingValues" reRender="pbSection" status="myStatus">
            <apex:param id="priceParam" name="priceParam" value="" />
            <apex:param id="yearsParam" name="yearsParam" value="" />
            <apex:param id="supplierParam" name="supplierParam" value="" />
        </apex:actionFunction>
        
        <!-- ======================================== -->
        <div id="col1">
            <apex:outputPanel rendered="{!!showSupplierList}">
                <apex:outputPanel id="searchFields">
                    <table id="pricingTable" class="pricingTable">
                        <tr>
                            <td class='tdLeft tdLeftOne '>
                                <apex:outputLabel value="Commodity: " />
                            </td>
                            <td class='tdLeft'>
                                <apex:selectList value="{!selectedCommodity}" multiselect="false"  size="1" id="TypePicklist" onchange="MarketPriceChanged()">
                                    <apex:selectOptions value="{!commodityOptions}" />
                                    <!-- <apex:actionSupport event="onchange" action="{!UpdateBusinessSize}"
rerender="pbSection" oncomplete="MarketPriceChanged();return false;" /> -->
                                </apex:selectList>
                            </td>
                        </tr>
                        <tr>
                            
                            <td class='tdLeft'>
                                <apex:outputLabel value="Market: " />
                            </td>
                            <td class='tdLeft'>
                                <apex:selectList value="{!selectedMarket}" multiselect="false" size="1" id="MaretPicklist" onchange="MarketPriceChanged()">
                                    <!-- <apex:actionSupport event="onchange" action="{!GoForSearch}" rerender="pbSection"/> -->
                                    <apex:selectOptions value="{!marketOptions}" />
                                </apex:selectList>
                            </td>
                        </tr>
                        
                        <tr>
                            <td class='tdLeft'>
                                &nbsp;
                            </td>
                            <td class='tdLeft'>
                                <apex:outputPanel >
                                    <div>
                                        <button rendered="{!!showSupplierList}" class="searchResult slds-vf-button_brand" > Search</button>
                                        <apex:actionFunction action="{!getSupplierList}" status="myStatus" name="searchResult" reRender="pbSection">
                                            
                                        </apex:actionFunction>
                                        
                                        <!--<apex:commandButton styleClass="slds-vf-button_brand" action="{!getSupplierList}"
value="Search" rendered="{!!showSupplierList}" rerender="pbSection" />  -->
                                        
                                        <script>
                                        $(document).on('click','.searchResult',function(){
                                            var childAcctIds = document.getElementById('{!$Component.childAccounts}');
                                            var result = [],
                                                checkboxes = $(document).find('li [data-role="checkbox"] input[type="checkbox"]');
                                            $.each(checkboxes, function () {
                                                var checkbox = $(this);                                                    
                                                if (checkbox.checkbox('state') === 'checked') {
                                                    result.push(checkbox.closest('li').data('id'));
                                                }
                                            });                                                
                                            childAcctIds.value = result;
                                            console.log(result);
                                            if(result.length >0){
                                                searchResult();
                                            }else{
                                                if(checkboxes.length>0){
                                                    alert("Please select any site");
                                                }else{
                                                    alert("Site not available for selected Commodity and Market");
                                                }
                                            }
                                            return false ;                                                
                                        })                                        
                                        
                                        </script>
                                    </div>
                                </apex:outputPanel>
                            </td>
                        </tr>
                    </table>
                </apex:outputPanel>
                
            </apex:outputPanel>
            
            
            
            <!-- ..................... -->
            
            <apex:outputPanel rendered="{!showSupplierList}">
                <apex:outputPanel >
                    <table id="pricingTable" class="pricingTable">
                        <tr>
                            <td class='tdLeft tdLeftOne'>
                                <apex:outputLabel value="Supplier: " />
                            </td>
                            <td class='tdLeft'>
                                <apex:inputHidden id="selectedSupplierValue" value="{!selectedSupplier}" />
                                <apex:repeat value="{!supplierOptions}" var="option">
                                    <input type="Checkbox" value="{!option.value}" Class="checkboxClass"
                                           onchange="setSupplierValue();return true;"
                                           id='{!option.value}' />{!option.Label}
                                    <br />
                                </apex:repeat>
                            </td>
                        </tr>
                    </table>
                </apex:outputPanel>
                <apex:outputPanel rendered="{!showGraph}">
                    <table class="pricingTable">
                        <tr>
                            <td class='tdLeft tdLeftOne'>
                                <apex:outputLabel value="Starting Month: " />
                            </td>
                            <td class='tdLeft'>
                                <apex:selectList value="{!selectedMonthYear}" multiselect="false" size="1">
                                    <!-- <apex:actionSupport event="onchange" action="{!getGraphData}" /> -->
                                    <apex:selectOptions value="{!monthOptions}" />
                                </apex:selectList>
                            </td>
                        </tr>
                    </table>
                </apex:outputPanel>
                <apex:outputPanel rendered="{!!noSuppliersFound}">
                    <table class="pricingTable">
                        <tr>
                            <td class='tdLeft tdLeftOne' >&nbsp;</td>
                            <td>
                                <apex:commandButton styleClass="slds-vf-button_brand" value="Refresh Chart" status="myStatus"
                                                    onclick="checkSupplierSelected(); return false;" rendered="{!showGraph}"/>
                                <apex:commandButton styleClass="slds-vf-button_brand" value="Show Chart" status="myStatus"
                                                    onclick="checkSupplierSelected(); return false;" rendered="{!!showGraph}"/>
                                <apex:actionfunction name="showPriceChart" action="{!getGraphData}"  status="myStatus" reRender="pbSection"/>
                                <script>
                                function checkSupplierSelected(){
                                    var checkBox = document.getElementsByClassName('checkboxClass');
                                    var selectedSuppVal = '';
                                    for (var i = 0; i < checkBox.length; i++) {
                                        if (checkBox[i].checked) {
                                            selectedSuppVal += checkBox[i].value + ';';
                                        }
                                    }
                                    selectedSuppVal = selectedSuppVal.substring(0, selectedSuppVal.length - 1);
                                    console.log('*** selectedSuppVal :: '+selectedSuppVal);
                                    if(selectedSuppVal != ''){
                                         showPriceChart();
                                    }else{
                                        var stringvalue='{!selectedPriceType}';
                                        console.log('##### stringvalue : '+stringvalue);
                                        if(checkBox.length>0){
                                            alert("Please select any supplier"); 
                                        }else{
                                            alert("Supplier not available for selected site Commodity and Market");
                                        }
                                        if(document.getElementById("j_id0:frm:pbSection:j_id138:0").value == stringvalue) {
                                            document.getElementById("j_id0:frm:pbSection:j_id138:0").checked = true;
                                        }else if(document.getElementById("j_id0:frm:pbSection:j_id138:1").value == stringvalue) {
                                            document.getElementById("j_id0:frm:pbSection:j_id138:1").checked = true;
                                        }                                        
                                    }
                                }
                                </script>
                                
                             <!--   <apex:commandButton styleClass="slds-vf-button_brand" action="{!getGraphData}"
                                                    value="Refresh Chart" status="myStatus" rerender="pbSection" rendered="{!showGraph}" />
                                <apex:commandButton styleClass="slds-vf-button_brand" action="{!getGraphData}"
                                                    value="Show Chart" rerender="pbSection" status="myStatus" rendered="{!!showGraph}" />    -->
                            </td>
                        </tr>
                    </table>
                    
                </apex:outputPanel>
            </apex:outputPanel>
            
            <!-- ..................... -->
            
            <apex:outputPanel id="dataPanel" rendered="{!showGraph}">
                
                <hr />
                <apex:pageMessages />
                <table id="pricingTable" class="pricingTable">
                    <tr>
                        <td class='tdLeft tdLeftOne'>
                            <apex:outputLabel value="Supplier Name: " />
                        </td>
                        <td class='tdLeft'>
                            <apex:outputText value="{!selectedSupplierFromChart}" />
                        </td>
                    </tr>
                    <tr>
                        <td class='tdLeft'>
                            <apex:outputLabel value="Selected Price: " />
                        </td>
                        <td class='tdLeft'>
                            <span style='margin-top: 6px;margin-left: 5px;position: absolute;'>$</span>
                            <apex:inputText value="{!selectedPrice}" >
                                <apex:actionSupport event="onchange" action="{!calculateSellingPrice}" />    
                            </apex:inputText>
                        </td> 
                    </tr> 
                    <tr>
                        <td class='tdLeft'>
                            <apex:outputLabel value="Margin Chosen (Min: {!minMargin} & Max: {!maxMargin})" />
                        </td>
                        <td class='tdLeft'>
                            <apex:inputText value="{!marginChosen}"  >
                                <apex:actionSupport event="onchange" action="{!calculateSellingPrice}" status="myStatus" reRender="dataPanel" />
                            </apex:inputText>
                        </td>
                    </tr>
                    
                    <tr>
                        <td class='tdLeft'>
                            <apex:outputLabel id="SellingPrice" value="Selling Price: " />
                        </td>
                        <td class='tdLeft'>
                            <apex:outputText value="{0, Number, Currency}" >
                                <apex:param value="{!sellingPrice}"/>
                            </apex:outputText>
                        </td>
                    </tr>
                    <tr>
                        <td class='tdLeft'>
                            <apex:outputLabel value="Term: " />
                        </td>
                        <td class='tdLeft'>
                            <apex:outputText value="{!selectedNbOfYears}" />
                        </td>
                    </tr>
                    <!--<tr>
<td class='tdLeft'>
<apex:outputLabel value="Starting Month: " />
</td>
<td class='tdLeft'>
<apex:selectList value="{!selectedMonthYear}" multiselect="false" size="1">
<apex:actionSupport event="onchange" action="{!getGraphData}"
rerender="pbSection" />
<apex:selectOptions value="{!monthOptions}" />
</apex:selectList>
</td>
</tr>-->
                </table>
                <apex:outputPanel rendered="{!showCalculation}">
                    <table id="commentsTable" class="pricingTable">
                        <tr>
                            <td class='tdLeft tdLeftOne'>
                                <apex:outputLabel value="Estimated Volume: " rendered="{!showCalculation}" />
                            </td>
                            <td class='tdLeft'>
                                <apex:inputText value="{!totalVolume}" rendered="{!showCalculation}">
                                    <apex:actionSupport event="onchange" action="{!calculateSellingPrice}"  />
                                </apex:inputText>
                            </td>
                        </tr>
                        <tr>
                            <td class='tdLeft'>
                                <apex:outputLabel value="Total Deal: " />
                            </td>
                            <td class='tdLeft'>
                                <apex:outputText value="{!totalDeal}" />
                            </td>
                        </tr>
                        
                        <tr>
                            <td class='tdLeft'>
                                &nbsp;
                            </td>
                            <td class='tdLeft'>
                                <apex:outputPanel rendered="{!IF(siteAccountIds == '', false, true)}" >
                                    <apex:commandButton styleClass="slds-vf-button_brand" id="saveOfferId" value="Generate Quote" action="{!createOppLineData}" oncomplete="sforce.one.navigateToURL()"
                                                        reRender="pbSection" rendered="{!showCalculation}" />
                                </apex:outputPanel>
                                
                            </td>
                        </tr>
                        
                    </table>
                </apex:outputPanel>
                
            </apex:outputPanel>
            
        </div>
        
        <!-- ======================================== -->
        
        
        
        <apex:outputPanel >
            <div id="col2" style="text-align: center;">
                
                
                <apex:outputPanel rendered="{!if(!showSupplierList && isSite,true,false)}">
                    <div class="slds-page-header" style="text-align:center;">
                        <div class="slds-page-header__row">
                            <div class="slds-page-header__col-title">
                                <div class="slds-media">
                                    <div class="slds-media__body">
                                        <div class="slds-page-header__name">
                                            <div class="slds-page-header__name-title">
                                                <h3>
                                                    <span class="slds-page-header__title slds-truncate"
                                                          title="Add Opportunity">Map Opportunity Site</span>
                                                </h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div data-role="wrapper" style="border-bottom: 1px solid #000;">
                        <div style="width:62px;float:left;margin-left:15px;">
                            <label class="bt-checkbox-bootstrap bt-checkbox-glyphicons">
                                <input type="checkbox" class="check-all" data-type="checkbox" data-checkbox="false" />
                                <span></span>
                            </label>
                        </div>
                        <div class='row-item header-row'>
                            <div class='account'>ACCOUNT</div>
                            <div class='market'>MARKET</div>
                            <div class='volume'>VOLUME</div>
                            <div class='type'>TYPE</div>
                            <div class='unitofmeasure'>UNIT OF MEASURE</div>
                        </div>                            
                    </div>
                    <apex:actionStatus id="getTreeStatus">
                        <apex:facet name="start">
                            <div style="position: relative; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.75; z-index: 1000; background-color: #fff;">
                                <div style="position: relative; left: 0; top: 0; bottom: 0; right: 0; z-index: 1001; margin: 0% 45%">
                                    <div class="demo-only demo-only demo-only_viewport" style="height: 6rem;"><div role="status" class="slds-spinner slds-spinner_medium"><span class="slds-assistive-text">Loading</span><div class="slds-spinner__dot-a"></div><div class="slds-spinner__dot-b"></div></div></div>
                                </div>
                            </div>
                        </apex:facet>
                    </apex:actionStatus>
                    <apex:outputPanel id="treeComponent">
                        <div id="lightningonSite" >
                            <div class="row"> 
                                <div id="tree"></div>
                                <div id="treeNoRecordFound" style="text-align:center;display:none;color:#ff0000;"> Site not available for selected Comodity and Market</div>
                            </div>
                            <script type="text/javascript">
                            $(document).ready(function () {
                                
                                var addressSiteMap = JSON.parse('{!jsonDataForAddressSite}') ;
                                
                                console.log(addressSiteMap.length);
                                
                                
                                console.log(addressSiteMap);
                                
                                var dataSource = [] ;
                                $.each(addressSiteMap,function(key,value){                                            
                                    
                                    var id = value.addressAccount.Id ;
                                    var text = createParentRow(value.addressAccount) ;
                                    var children = [] ;
                                    var childData = value.siteList
                                    
                                    $.each(childData,function(keySite,valueSite){
                                        var site = { id:valueSite.Id, text: createChildRow(valueSite) };
                                        children.push(site) ;
                                    });
                                    
                                    if(children.length==0){
                                        // If site is not available than dont show address
                                    }else{
                                        
                                        dataSource.push({ 
                                            id: id,
                                            text: text, 
                                            children: children,
                                            style: {
                                                item: 'list-group-item '
                                            }
                                        });
                                    }
                                });
                                if(dataSource.length  > 0 ){
                                    $("#treeNoRecordFound").hide() ;
                                    $("#tree").show() ;
                                }else{
                                    $("#treeNoRecordFound").show() ;
                                    $("#tree").hide() ;
                                }   
                                var tree = $('#tree').tree({
                                    primaryKey: 'id',
                                    uiLibrary: 'bootstrap',
                                    //dataSource: '/Locations/Get',
                                    // dataSource: [ { id: 12, text: 'foo', children: [ { id: 23, text: 'bar' } ] } ]
                                    dataSource: dataSource,
                                    checkboxes: true
                                    
                                });
                                $('#btnSave').on('click', function () {
                                    var checkedIds = tree.getCheckedNodes();
                                    alert(checkedIds);
                                    return false ;
                                });
                                
                                function createParentRow(rowData){
                                    //console.log(rowData);
                                    var account = "<div class='account'>"+ rowData.Name+"</div>";
                                    var market = "<div class='market'>"+ rowData.Market__r.Name+"</div>";
                                    var volume = "<div class='volume'>&nbsp;</div>";
                                    var type = "<div class='type'>&nbsp;</div>";
                                    var unitofmeasure = "<div class='unitofmeasure'>&nbsp;</div>";
                                    var row = "<div class='row-item dispmarket "+rowData.Market__c+" '>"+account+market+volume+type+unitofmeasure+"</div>";
                                    return row;
                                }
                                function createChildRow(rowData){
                                    //console.log(rowData);
                                    var account = "<div class='account'>"+ rowData.Name+"</div>";
                                    var market = "<div class='market'>&nbsp;</div>";
                                    var volume = "<div class='volume'>"+ rowData.Volume__c+"</div>";
                                    var type = "<div class='type'>"+ rowData.Type__c+"</div>";
                                    var unitofmeasure = "<div class='unitofmeasure'>"+ rowData.Unit_of_Measure__c+"</div>";
                                    var row = "<div class='row-item  "+rowData.Market__c+" '>"+account+market+volume+type+unitofmeasure+"</div>";
                                    return row;
                                }
                                
                                $(document).on('click',".check-all",function(){
                                    if($(this).is(":checked")){
                                        checkboxes = $(document).find('#tree [data-role="checkbox"] input[type="checkbox"]');
                                        $.each(checkboxes, function () {
                                            var checkbox = $(this);
                                            checkbox.checkbox('state', 'checked');
                                            
                                        });
                                    }else{
                                        checkboxes = $(document).find('#tree [data-role="checkbox"] input[type="checkbox"]');
                                        $.each(checkboxes, function () {
                                            var checkbox = $(this);
                                            
                                            checkbox.checkbox('state', 'unchecked');
                                        });
                                    }              
                                });
                                
                                $(document).find('li [data-role="checkbox"] input[type="checkbox"]').on('click',function(){
                                    checkboxes = $(document).find('#tree [data-role="checkbox"] input[type="checkbox"]');
                                    var checkAll = true ; 
                                    $.each(checkboxes, function () {
                                        var checkbox = $(this);
                                        if (checkbox.checkbox('state') === 'checked') {
                                            
                                        }else{
                                            checkAll = false ;
                                        }
                                        $(".check-all").prop('checked',checkAll);
                                    });
                                    
                                })
                                
                                
                            });
                            </script>
                            
                        </div>
                    </apex:outputPanel>
                    
                    <div class="slds-p-left_none">
                        
                    </div>
                    <apex:outputPanel rendered="{!IF(siteAccountIds == '', false, true)}">
                        <div class="slds-text-align_center">
                            No result for your search!
                        </div>
                    </apex:outputPanel>
                    
                    <script>
                    function setSiteValJS(val) {
                        setSiteVal(val);
                    }
                    
                    function setValueToLookupField(val, lookupId) {
                        document.getElementById('{!$Component.lookupField}').value = val;
                        document.getElementById('{!$Component.lookupIdField}').value = lookupId;
                        closePopup();
                    }
                    
                    function closePopup() {
                        //document.getElementById('popupWindow').style.display = 'none';
                    }
                    
                    function openPopup() {
                        //document.getElementById('popupWindow').style.display = 'block';
                    }
                    
                    var deleteIconURL =
                        "{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#delete')}";
                    var addIconURL =
                        "{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#add')}";
                    rerenderIcons();
                    
                    function rerenderIcons() {
                        var x = document.getElementsByClassName("addIconSVG");
                        for (var i = 0; i < x.length; i++) {
                            x[i].innerHTML =
                                '<svg class="slds-icon slds-icon-text-default slds-icon_small"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="' +
                                addIconURL + '"/></svg>';
                        }
                        var x = document.getElementsByClassName("deleteIconSVG");
                        for (var i = 0; i < x.length; i++) {
                            x[i].innerHTML =
                                '<svg class="slds-icon slds-icon-text-default slds-icon_small"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="' +
                                deleteIconURL + '"/></svg>';
                        }
                    }
                    </script>
                </apex:outputPanel>
                
                <apex:outputPanel rendered="{!noSuppliersFound}">
                    <div class="errorDiv">No Supplier found for the selected criteria</div>
                </apex:outputPanel>
                <apex:outputPanel rendered="{!showGraph}">
                    <table>
                        <tr>
                            <td style="width: 40%;padding-left: 2%;">
                                <apex:outputPanel id="sizePanel"  >
                                    <H1 style="font-size:20px;"> Business Size: </H1>
                                    <apex:outputText value="{!selectedSize}" />
                                </apex:outputPanel>
                            </td>
                            <td><apex:outputPanel id="Selectedsites">
                                <apex:variable var="serialno" value="{!1}"/>
                                <div >
                                    <apex:outputPanel rendered="{!IF(siteAccountIds == '', false, true)}">
                                        <div class="tooltip"><h1 style="font-size:20px;"> Site Name: </h1>
                                          <span class="tooltiptext">
                                              <apex:repeat var="data" value="{!selctedAcc}">
                                                  {!serialno}.
                                                  <apex:outputText value="{!data.site.Name}" id="sit"/>
                                                  <br />
                                                  <apex:variable var="serialno" value="{!serialno+1}"/>
                                              </apex:repeat>
                                           </span>
                                        </div>
                                    </apex:outputPanel>
                                </div>  
                                </apex:outputPanel></td>
                        </tr>
                        
                        <tr>
                            <td class="radio-btn">
                                <apex:outputPanel >
                                    <apex:selectRadio value="{!selectedPriceType}" onchange="checkSupplierSelected(); return false;">
                                        <apex:selectOption id="radioFixed" itemValue="Fixed" itemLabel="Fixed"></apex:selectOption>
                                        <apex:selectOption id="radioVariable" itemValue="Variable" itemLabel="Variable" ></apex:selectOption>                                    
                                     <!--   <apex:actionSupport event="onchange" 
                                                        action="{!getGraphData}" 
                                                              status="myStatus" reRender="pbSection" />  -->
                                    </apex:selectRadio>
                                </apex:outputPanel>
                            </td>
                            <td>&nbsp;</td>
                        </tr>
                    </table>
                    
                    <apex:outputPanel id="chartPanel">
                        <apex:outputText value="{!Effective_String}" escape="false"/> 
                        <div class="demo-only" id='ZeroModal' style="height:4rem;display:none;">
                            <div class="slds-notify_container slds-is-relative">
                                <div class="slds-notify slds-notify_toast slds-theme_info" role="status">
                                    <span class="slds-assistive-text">info</span>
                                    <div class="slds-notify__content">
                                        <h2 class="slds-text-heading_small">
                                            Info: Invalid price data. 
                                        </h2>
                                    </div>
                                    <div class="slds-notify__close">
                                        <button class="slds-button slds-button_icon slds-button_icon-inverse" onclick="javascrit:document.getElementById('ZeroModal').style.display = 'none';return false;" title="Close">
                                            X
                                            <span class="slds-assistive-text">Close</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="chart_div" style="width: 100%; height: 500px;" />
                    </apex:outputPanel>
                    
                </apex:outputPanel>
            </div>
        </apex:outputPanel>
        
        <!-- ======================================== -->
        <apex:outputPanel >
            <div style="text-align: center !important;">   
                <br />
                <apex:commandButton styleClass="slds-vf-button_brand " action="{!reloadPage}" value="New Search" oncomplete="refreshPage();return false;" />
                <apex:commandButton styleClass="slds-vf-button_brand " action="{!backToAccount}" value="Back To Account"/>
            </div>
        </apex:outputPanel>
        
    </apex:pageBlock>
    
    <apex:actionFunction action="{!getTreeData}" name="TreeData" reRender="treeComponent" status="getTreeStatus">
        <apex:param id="selectedMarket" name="selectedMarket" assignTo="{!selectedMarket}" value="" />    
        <apex:param id="selectedCommodity" name="selectedCommodity" assignTo="{!selectedCommodity}" value="" /> 
    </apex:actionFunction>
    
    
    
    <script>
    $(document).ready(function () {
        $("#lightningonSite").hide();
        var market = document.getElementById("j_id0:frm:pbSection:MaretPicklist").value ;
        var type = document.getElementById("j_id0:frm:pbSection:TypePicklist").value ;
        TreeData(market,type);
    })
    
    function MarketPriceChanged(){
        
        $("#lightningonSite").hide();
        
        var market = document.getElementById("j_id0:frm:pbSection:MaretPicklist").value ;
        var type = document.getElementById("j_id0:frm:pbSection:TypePicklist").value ;
        var recordid ="{!$CurrentPage.parameters.Id}";
        TreeData(market,type);
        $(".check-all").prop('checked',false);

    }
    
    
    function setOppIndex(val) {
        openPopup();
    }
    function submitListener(e){
        
        var keynum = 0;
        if (window.event){
            keynum = window.event.keyCode;
        }
        else if (e.which){
            keynum = e.which;
        }
        
        // Here we check whether the Enter button was pressed
        if (keynum == 13){
            
            e.preventDefault();
            return false;
        }
    }
    var el = document.getElementById("col1");
    if(el != undefined){
        el.onkeydown = function(evt) {
            if (el.keyCode === 13 || el.which === 13) {
                alert('I am in');
                return false;
            };
        };
    }
    
    </script>
</apex:form>

</body>

</apex:page>